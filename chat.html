<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat en Ligne</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Rowdies:wght@400;700&display=swap">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Rowdies', sans-serif;
            background-image: url('fondécran.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: white;
        }

        .container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        .box {
            width: 450px; /* Agrandi la boîte */
            padding: 30px; /* Augmente l'espacement interne */
            background: rgba(0, 0, 0, 0.85); /* Légèrement plus sombre */
            border-radius: 15px; /* Plus d'arrondi */
            text-align: center;
        }

        .box input,
        .box button {
            width: 100%;
            padding: 12px; /* Légèrement plus grand */
            margin: 12px 0; /* Plus d'espacement entre les éléments */
            border: none;
            border-radius: 5px;
        }

        .box input {
            font-size: 16px;
        }

        .box button {
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
        }

        .box button:hover {
            background-color: #45a049;
        }

        #messagesBox {
            display: none;
            width: 450px;
            height: 600px;
            padding: 20px; /* Plus d'espace autour des messages */
            background: rgba(0, 0, 0, 0.9);
            border-radius: 15px;
            color: white;
            overflow-y: auto;
            position: relative;
        }

        #sendMsg {
            display: flex;
            position: absolute;
            bottom: 10px;
            width: 90%;
        }

        #msgTxt {
            flex: 1;
            padding: 10px;
            border-radius: 5px;
            border: none;
            font-size: 16px;
        }

        #msgBtn {
            width: 100px;
            margin-left: 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #msgBtn:hover {
            background-color: #0056b3;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="box" id="lobbyBox">
            <h2>Créer ou Rejoindre un Salon</h2>
            <input type="text" id="roomName" placeholder="Nom du salon">
            <input type="password" id="roomPassword" placeholder="Mot de passe du salon">
            <button onclick="createRoom()">Créer Salon</button>
            <input type="text" id="enterName" placeholder="Pseudo">
            <input type="password" id="enterPassword" placeholder="Mot de passe du salon">
            <button onclick="enterRoom()">Rejoindre Salon</button>
        </div>

        <div id="messagesBox">
            <div id="messages"></div>
            <div id="sendMsg">
                <input type="text" id="msgTxt" placeholder="Message...">
                <button id="msgBtn" onclick="sendMsg()">Envoyer</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getDatabase, ref, set, get, remove, query, orderByKey } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

        const firebaseConfig = {
              apiKey: "AIzaSyA_o5fz_3ELok5uTDgJfIhL7hzqv4-US6I",
              authDomain: "manuelsseconde.firebaseapp.com",
              databaseURL: "https://manuelsseconde-default-rtdb.europe-west1.firebasedatabase.app",
              projectId: "manuelsseconde",
              storageBucket: "manuelsseconde.appspot.com",
              messagingSenderId: "369461165606",
              appId: "1:369461165606:web:6bd9186ee95e3701d3f0e7",
          };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Variables globales
        var roomName, roomPassword, pseudo;
        const twelveHours = 12 * 60 * 60 * 1000; // 12 heures en millisecondes

        // Créer un salon
        window.createRoom = function () {
            roomName = document.getElementById("roomName").value;
            roomPassword = document.getElementById("roomPassword").value;

            if (roomName && roomPassword) {
                const timestamp = new Date().getTime();
                set(ref(db, `rooms/${roomName}`), {
                    password: roomPassword,
                    timestamp: timestamp
                }).then(() => {
                    sessionStorage.setItem("roomName", roomName);
                    loadMessages();
                });
            } else {
                alert("Veuillez entrer un nom de salon et un mot de passe.");
            }
        };

        // Rejoindre un salon
        window.enterRoom = function () {
            roomName = document.getElementById("roomName").value;
            roomPassword = document.getElementById("enterPassword").value;
            pseudo = document.getElementById("enterName").value;

            get(ref(db, `rooms/${roomName}`)).then((snapshot) => {
                if (snapshot.exists() && snapshot.val().password === roomPassword) {
                    sessionStorage.setItem("roomName", roomName);
                    sessionStorage.setItem("pseudo", pseudo);
                    loadMessages();
                } else {
                    alert("Mot de passe incorrect ou salon inexistant.");
                }
            });
        };

        // Charger les messages
        function loadMessages() {
            document.getElementById("lobbyBox").style.display = "none";
            document.getElementById("messagesBox").style.display = "block";
            onChildAdded(ref(db, `messages/${roomName}`), (data) => {
                const message = data.val();
                const msgElement = document.createElement("div");
                msgElement.textContent = `${message.sender}: ${message.msg}`;
                document.getElementById("messages").appendChild(msgElement);
            });
        }

        // Envoyer un message
        window.sendMsg = function () {
            const msgTxt = document.getElementById("msgTxt").value;
            const timestamp = new Date().getTime();
            set(ref(db, `messages/${roomName}/${timestamp}`), {
                sender: sessionStorage.getItem("pseudo"),
                msg: msgTxt,
                timestamp: timestamp
            });
            document.getElementById("msgTxt").value = "";
        };

        // Suppression automatique après 12 heures
        function autoDeleteRooms() {
            const currentTime = new Date().getTime();
            get(query(ref(db, "rooms"), orderByKey())).then((snapshot) => {
                snapshot.forEach((roomSnapshot) => {
                    const roomData = roomSnapshot.val();
                    if (currentTime - roomData.timestamp >= twelveHours) {
                        remove(ref(db, `rooms/${roomSnapshot.key}`));
                        remove(ref(db, `messages/${roomSnapshot.key}`));
                    }
                });
            });
        }

        // Lancer la suppression automatique toutes les heures
        setInterval(autoDeleteRooms, 60 * 60 * 1000);
    </script>
</body>

</html>
